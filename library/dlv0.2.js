(()=>{!function(){"use strict";var e=/\[object (Boolean|Number|String|Function|Array|Date|RegExp|Arguments)\]/;function t(t){return null==t?String(t):(t=e.exec(Object.prototype.toString.call(Object(t))))?t[1].toLowerCase():"object"}function s(e,t){return Object.prototype.hasOwnProperty.call(Object(e),t)}function i(e){if(!e||"object"!=t(e)||e.nodeType||e==e.window)return!1;try{if(e.constructor&&!s(e,"constructor")&&!s(e.constructor.prototype,"isPrototypeOf"))return!1}catch(e){return!1}for(var i in e);return void 0===i||s(e,i)}function n(e,t){var s={},i=s;e=e.split(".");for(var n=0;n<e.length-1;n++)i=i[e[n]]={};return i[e[e.length-1]]=t,s}function r(e,n){var o,a=!e._clear;for(o in e)if(s(e,o)){var l=e[o];"array"===t(l)&&a?("array"===t(n[o])||(n[o]=[]),r(l,n[o])):i(l)&&a?(i(n[o])||(n[o]={}),r(l,n[o])):n[o]=l}delete n._clear}function o(e,t,s){t="function"==typeof(t=void 0===t?{}:t)?{listener:t,listenToPast:void 0!==s&&s,processNow:!0,commandProcessors:{}}:{listener:t.listener||function(){},listenToPast:t.listenToPast||!1,processNow:void 0===t.processNow||t.processNow,commandProcessors:t.commandProcessors||{}},this.a=e,this.l=t.listener,this.j=t.listenToPast,this.g=this.i=!1,this.c={},this.f=[],this.b=t.commandProcessors,this.h=function(e){return{set:function(t,s){r(n(t,s),e.c)},get:function(t){return e.get(t)}}}(this);var i=this.a.push,o=this;this.a.push=function(){var e=[].slice.call(arguments,0),t=i.apply(o.a,e);return a(o,e),t},t.processNow&&this.process()}function a(e,s,o){if(o=void 0!==o&&o,e.i&&(e.f.push.apply(e.f,s),!e.g))for(;0<e.f.length;){if("array"===t(s=e.f.shift()))e:{var a=e.c;t(s[0]);for(var l=s[0].split("."),h=l.pop(),c=s.slice(1),u=0;u<l.length;u++){if(void 0===a[l[u]])break e;a=a[l[u]]}try{a[h].apply(a,c)}catch(e){}}else if("arguments"===t(s)){if(l=e,h=[],c=s[0],l.b[c])for(a=l.b[c].length,u=0;u<a;u++)h.push(l.b[c][u].apply(l.h,[].slice.call(s,1)));e.f.push.apply(e.f,h)}else if("function"==typeof s)try{s.call(e.h)}catch(e){}else{if(!i(s))continue;for(var g in s)r(n(g,s[g]),e.c)}o||(e.g=!0,e.l(e.c,s),e.g=!1)}}o.prototype.process=function(){this.registerProcessor("set",(function(){var e={};return 1===arguments.length&&"object"===t(arguments[0])?e=arguments[0]:2===arguments.length&&"string"===t(arguments[0])&&(e=n(arguments[0],arguments[1])),e})),this.i=!0;for(var e=this.a.length,s=0;s<e;s++)a(this,[this.a[s]],!this.j)},o.prototype.get=function(e){var t=this.c;e=e.split(".");for(var s=0;s<e.length;s++){if(void 0===t[e[s]])return;t=t[e[s]]}return t},o.prototype.flatten=function(){this.a.splice(0,this.a.length),this.a[0]={},r(this.c,this.a[0])},o.prototype.registerProcessor=function(e,t){e in this.b||(this.b[e]=[]),this.b[e].push(t)},o.prototype.registerProcessor=o.prototype.registerProcessor,o.prototype.flatten=o.prototype.flatten,o.prototype.get=o.prototype.get,o.prototype.process=o.prototype.process,window.DataLayerHelper=o}();class e{static MODELS="dlval-models";static FORMS="dlval-forms";constructor(e=!1){e||(this.clearAllForms(),this.clearAllModels())}getForm(e){return this.getAllForms()[e]}storeForm(t,s){const i=this.getAllForms();i[t]=s,localStorage.setItem(e.FORMS,JSON.stringify(i))}getAllForms(){const t=localStorage.getItem(e.FORMS)||"{}";return JSON.parse(t)}clearAllForms(){localStorage.removeItem(e.FORMS)}storeModel(t,s){const i=this.getAllModels(),n=i[t]||[],r=JSON.stringify(s);for(let e=0;e<n.length;e++){if(r==JSON.stringify(n[e]))return}n.push(s),i[t]=n,localStorage.setItem(e.MODELS,JSON.stringify(i))}getAllModels(){const t=localStorage.getItem(e.MODELS)||"{}";return JSON.parse(t)}getModels(e){return this.getAllModels()[e]||[]}clearAllModels(){localStorage.removeItem(e.MODELS)}}class t{constructor(e){this.storage=e,this.checks=[]}addCheck(e){this.checks.push(e)}checkModel(e,t){const s=this.checks.find((t=>t.model==e));if(s){const e=this.#e(s.unique,t),i=this.storage.getModels(e),n=this.#t(t,i,s.params);return this.storage.storeModel(e,t),n}}#t(e,t,s){const i={};return t.forEach((t=>{s.forEach((s=>{t[s]!=e[s]&&(i[s]=i[s]||new Set,i[s].add(this.#s(t[s])),i[s].add(this.#s(e[s])))}))})),Object.keys(i).forEach((e=>{i[e]=Array.from(i[e].values())})),Object.keys(i).length?i:null}#e(e,t){return e.map((e=>t[e])).join("-")}#s(e){return"string"==typeof e?`"${e}"`:null===e?"null":void 0===e?"undefined":e}}class s{constructor(e,t){this.storage=t,this.settings=e}onEvent(e){const t=e[this.settings.params.id],s=this.#i(e.event),i={};if(s&&t){const n=this.storage.getForm(t)||{lastInputs:{}},r=this.settings.forms.find((e=>e.id==t)),o=e[this.settings.params.stepName],a=e[this.settings.params.fieldName],l=e[this.settings.params.fieldValue],h=this.#n(e[this.settings.params.inputElement]);switch(!!this.settings.forms.find((e=>e.id===t))||(i[this.settings.params.id]=`unknown form '${t}' - known forms are: ${this.settings.forms.map((e=>e.id)).join(", ")}`),s){case"start":n.inProgress&&(i.event="start event already detected for this form"),n.inProgress=!0;break;case"complete":case"abandon":n.inProgress||(i.event=`form not started: ${t}`),n.inProgress=!1;break;case"step":case"field":case"error":case"submit":n.inProgress||(i.event=`form not started: ${t}`)}switch(s){case"step":o&&(r.steps?.length&&!r.steps.includes(o)&&(i[this.settings.params.stepName]=`unknown step '${o}' - known steps are: ${r.steps.join(", ")}`),n.lastStepName==o&&(i[this.settings.params.stepName]="already on this step"),n.lastStepName=o);break;case"field":if(a&&h){h==n.lastInputs[a]&&(i.event="field value has not changed since last event"),n.lastInputs[a]=h}if(a&&l){const e=this.#r(a,l);console.log("grrr",e),e&&(i[this.settings.params.fieldValue]="potential PII detected - should this be undefined?")}}n.lastEventId=s,this.storage.storeForm(t,n)}return i}#r(e,t){return!!t&&(!!/.+\@.+\..+/i.test(t)||(e=e.toLowerCase(),-1!=["first name","last name","name","email","email address","phone","telephone","phone number","mobile","mobile number","dob","date of birth"].indexOf(e)))}#n(e){if(e&&e instanceof HTMLElement&&["INPUT","TEXTAREA","SELECT"].includes(e.tagName))return e.value}#i(e){const t=this.settings.events;for(let s in t)if(t[s]==e)return s}}class i{static TYPE_STRING="string";static TYPE_ARRAY="array";static TYPE_OBJECT="object";static TYPE_BOOLEAN="boolean";static TYPE_INTEGER="integer";static TYPE_DECIMAL2="decimal2";static TYPE_DECIMAL="decimal";static TYPE_INPUT_ELEMENT="input element";static TYPE_HTML_ELEMENT="html element";static TYPE_UNKNOWN="unknown";constructor(e){this.config=e,this.config.events.forEach((e=>{if(e.params=e.params||[],e.model){const t=this.getModelParamSchemas(e.model);e.params.forEach((e=>{for(let s=0;s<t.length;s++)t[s].key==e.key&&(t.splice(s,1),s--)})),e.params=[...t,...e.params]}})),this.modelConsistency=e.modelConsistency,this.client=e.client,this.project=e.project}findEventNameFromAliases(e){if(!this.config.eventAliases)return null;for(let t=0;t<this.config.eventAliases.length;t++){const s=this.config.eventAliases[t];if(e.event==[s.event])return{value:e[s.alias],alias:s.alias}}}isInitialData(e){if(!this.config.initialData)return!1;let t=0;const s=this.config.initialData.identifiedBy;for(let i=0;i<s.length;i++)null!=e[s[i]]&&t++;return t===s.length}isIgnoredEvent(e){if(!e||!this.config.ignoredEvents)return!1;for(let t=0;t<this.config.ignoredEvents.length;t++){const s=this.config.ignoredEvents[t];if(new RegExp(s,"i").test(e))return!0}return!1}isValidEventNameFormat(e){if(!e||!this.config.globalEventNameValidation)return!0;for(let t=0;t<this.config.globalEventNameValidation.length;t++){const s=this.config.globalEventNameValidation[t];if(!new RegExp(s).test(e))return!1}return!0}findEventSchema(e){return this.config.events.find((t=>t.event==e))}getModelParamSchemas(e){return(this.config.models[e]||[]).slice(0)}getUnknownParamSchemasForObj(e,t){t=t||[];const s=[];return Object.keys(e).forEach((i=>{"event"===i||t.find((e=>e.key===i))||s.push({nonSchema:!0,key:i,type:this.getInferedType(e[i])})})),s}getInferedType(e){return e instanceof HTMLElement?["INPUT","TEXTAREA","SELECT"].includes(e.tagName)?i.TYPE_INPUT_ELEMENT:i.TYPE_HTML_ELEMENT:Array.isArray(e)?i.TYPE_ARRAY:"object"==typeof e?i.TYPE_OBJECT:"string"==typeof e?i.TYPE_STRING:"boolean"==typeof e?i.TYPE_BOOLEAN:"number"==typeof e?Math.round(e)===e?i.TYPE_INTEGER:Number(e.toFixed(2))===e?i.TYPE_DECIMAL2:i.TYPE_DECIMAL:i.TYPE_UNKNOWN}}class n{constructor(e,t="black"){this.console=e,this.bgCol=t,this.args=[],this.styles=[],this.bgCol="black",this.strike=!1}setStrike(e){return this.strike=!!e,this}pushStyled(e,t,s=!1,i="12px",n="black"){return this.args.push(`%c${e}`),this.styles.push(`font-size: ${i}; ${s?"font-style: italic;":""} ${t?"color: "+t+";":""} padding-left: 4px; background: ${n}; text-decoration: ${this.strike?"line-through":"none"};`),this}pushKey(e){return this.pushStyled(e,"aqua")}pushType(e){return this.pushStyled(e,"grey")}pushIssue(e){return this.pushStyled(e,"lightcoral")}pushValue(e){return this.pushStyled(e,"lightskyblue")}pushTick(){return this.pushStyled("✔️ ok","lime")}pushX(){return this.pushStyled("❌","red")}pushWarn(){return this.pushStyled("⚠️","yellow")}log(){this.console.log(...this.#o(arguments)),this.args=[],this.styles=[]}group(){this.console.group(...this.#o(arguments)),this.args=[],this.styles=[]}groupCollapsed(){this.console.groupCollapsed(...this.#o(arguments)),this.args=[],this.styles=[]}#o(e){const t=[this.args.join(""),...this.styles];return e&&t.push(...e),t}}class r{constructor(e,t){this.logger=new n(window.console),this.logger.pushStyled(`DATALAYER VALIDATOR - ${e} - ${t}`,"lightgreen").log()}logResult(e){this.logger.setStrike(!1).pushStyled("VALIDATING","yellow").group(),this.logger.pushStyled("event","yellow").pushType("string").pushStyled(e.event.value,"yellow"),null!=e.event.ok&&(e.event.ok?this.logger.pushTick():this.logger.pushX()),e.event.issue&&this.logger.pushIssue(e.event.issue),this.logger.log(),e.params.forEach((e=>this.#a(e))),console.groupEnd()}#a(e,t){if(e.type===i.TYPE_ARRAY||e.type===i.TYPE_OBJECT){const t=this.#l(e);this.logger.setStrike(e.schema.nonSchema).pushKey(e.schema.key).pushType(t),!0===e.ok&&this.logger.pushTick(),!1===e.ok&&this.logger.pushX(),e.issue&&this.logger.pushIssue(e.issue),this.logger.group();Object.keys(e.children).forEach((t=>this.#a(e.children[t],e.consistency))),console.groupEnd()}else{const s=[i.TYPE_INPUT_ELEMENT,i.TYPE_HTML_ELEMENT].includes(e.schema.type);this.logger.setStrike(e.schema.nonSchema).pushKey(e.schema.key).pushType(e.schema.type).pushValue(s?`<${e.value.tagName.toLowerCase()}>`:e.value),!0!==e.ok||e.schema.nonSchema||"(not set)"==e.value||this.logger.pushTick(),!1===e.ok&&this.logger.pushX(),e.issue&&this.logger.pushIssue(e.issue),this.logger.log(),t&&t[e.schema.key]&&this.logger.pushWarn().pushStyled(`inconsistent ${e.schema.key} detected across events: `,"palegoldenrod").log(t[e.schema.key].join(" | "))}}#l(e){const t=e.type===i.TYPE_ARRAY?e.value.length:Object.keys(e.value).length;return e.type===i.TYPE_ARRAY?`array[${t}] (${e.schema.nonSchema?"unknown":e.schema.itemType})`:`object[${t}]`}}class o{constructor(n,o){n.dataLayer=n.dataLayer||[],this.schema=new i(o),this.storage=new e,this.consistency=new t(this.storage),this.schema.modelConsistency.forEach((e=>this.consistency.addCheck(e))),this.schema.formSettings&&(this.formCheck=new s(this.schema.formSettings,this.storage)),this.display=new r(this.schema.client,this.schema.project),this.helper=new DataLayerHelper(n.dataLayer,{listenToPast:!0,listener:this.#h.bind(this)})}reset(){this.storage.clearAllModels()}#c(e,t){t=t||[];for(let s=0;s<t.length;s++){if(!new RegExp(t[s],"i").test(e))return s}return-1}#u(e){return!(e=e.toLowerCase()).length||"null"==e||"undefined"==e}#g(e,t){const s={schema:t,value:e[t.key],ok:!0,children:{}};t.required&&null==e[t.key]&&(s.ok=!1,s.issue="required param is missing");const n=e[t.key];if(null!=n){const e=this.schema.getInferedType(n);if(s.type=e,t.nonSchema||e===t.type){if(e===i.TYPE_STRING){if(this.#u(n))s.ok=!1,s.issue="please use raw undefined";else if(this.#p(n))s.ok=!1,s.issue="asian characters detected in value";else if(t.uppercase&&!this.#m(n))s.ok=!1,s.issue="value must be all upper case";else if(t.lowercase&&!this.#d(n))s.ok=!1,s.issue="value must be all lower case";else{const e=this.#c(n,t.validation);-1!=e&&(s.ok=!1,s.issue="should match regex: "+t.validation[e])}s.value='"'+s.value+'"'}else if(e===i.TYPE_ARRAY)n.length?(s.ok=null,n.forEach(((e,i)=>{s.children[i]=this.#g(n,{key:i,nonSchema:t.nonSchema,type:t.itemType,model:t.model,required:!0})}))):t.required&&(s.ok=!1,s.issue="at least one item is required");else if(e===i.TYPE_OBJECT){s.ok=null;let e=[];if(t.model){const i=this.schema.getModelParamSchemas(t.model),r=this.schema.getUnknownParamSchemasForObj(n,i);e=[...i,...r],s.consistency=this.consistency.checkModel(t.model,n)}if(t.properties){const s=this.schema.getUnknownParamSchemasForObj(n,t.properties);e=[...t.properties,...s]}e.forEach(((e,t)=>{s.children[e.key]=this.#g(n,e)}))}}else s.ok=!1,s.issue="should be of type "+t.type}else e.hasOwnProperty(t.key)||(s.value="(not set)");return s}#p(e){return/\p{Script=Han}/u.test(e)}#m(e){return e===e.toUpperCase()}#d(e){return e===e.toLowerCase()}#h(e,t){if("object"!=typeof t||Array.from(t).length)return;if(this.schema.isIgnoredEvent(t.event))return;const s=this.schema.findEventNameFromAliases(t);s&&(t.event=s.value);const i={msg:t,event:{ok:!0,value:t.event+(s?` (via ${s.alias})`:"")},params:[]};if(!t.event){return void(this.schema.isInitialData(t)?(i.event.value="(initial data)",i.event.ok=!0,i.params=this.schema.config.initialData.params.map((e=>this.#g(t,e))),this.display.logResult(i)):(i.event.value="(not set)",i.event.ok=null,this.display.logResult(i)))}const n=this.schema.findEventSchema(t.event);if(n){this.schema.isValidEventNameFormat(t.event)||(i.event.ok=!1,i.event.issue="must satisfy regex: "+this.schema.config.globalEventNameValidation.join(" // "));const e=this.schema.getUnknownParamSchemasForObj(t,n.params);i.params=[...n.params,...e].map((e=>this.#g(t,e)))}else{i.event.ok=!1,i.event.issue="unknown schema event";const e=this.schema.getUnknownParamSchemasForObj(t);i.params=e.map((e=>this.#g(t,e)))}if(this.formCheck){const e=this.formCheck.onEvent(t);e.event&&(i.event.ok=!1,i.event.issue=e.event),i.params.forEach((t=>{!1!==t.ok&&e[t.schema.key]&&(t.ok=!1,t.issue=e[t.schema.key])}))}this.display.logResult(i)}}window.initDataLayerValidator=e=>{"string"!=typeof e?"object"!=typeof e||new o(window,e):fetch(e).then((e=>e.json())).then((e=>{new o(window,e)}))}})();
