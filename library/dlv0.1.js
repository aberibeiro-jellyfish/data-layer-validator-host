(()=>{!function(){"use strict";var e=/\[object (Boolean|Number|String|Function|Array|Date|RegExp|Arguments)\]/;function t(t){return null==t?String(t):(t=e.exec(Object.prototype.toString.call(Object(t))))?t[1].toLowerCase():"object"}function s(e,t){return Object.prototype.hasOwnProperty.call(Object(e),t)}function r(e){if(!e||"object"!=t(e)||e.nodeType||e==e.window)return!1;try{if(e.constructor&&!s(e,"constructor")&&!s(e.constructor.prototype,"isPrototypeOf"))return!1}catch(e){return!1}for(var r in e);return void 0===r||s(e,r)}function o(e,t){var s={},r=s;e=e.split(".");for(var o=0;o<e.length-1;o++)r=r[e[o]]={};return r[e[e.length-1]]=t,s}function i(e,o){var n,a=!e._clear;for(n in e)if(s(e,n)){var l=e[n];"array"===t(l)&&a?("array"===t(o[n])||(o[n]=[]),i(l,o[n])):r(l)&&a?(r(o[n])||(o[n]={}),i(l,o[n])):o[n]=l}delete o._clear}function n(e,t,s){t="function"==typeof(t=void 0===t?{}:t)?{listener:t,listenToPast:void 0!==s&&s,processNow:!0,commandProcessors:{}}:{listener:t.listener||function(){},listenToPast:t.listenToPast||!1,processNow:void 0===t.processNow||t.processNow,commandProcessors:t.commandProcessors||{}},this.a=e,this.l=t.listener,this.j=t.listenToPast,this.g=this.i=!1,this.c={},this.f=[],this.b=t.commandProcessors,this.h=function(e){return{set:function(t,s){i(o(t,s),e.c)},get:function(t){return e.get(t)}}}(this);var r=this.a.push,n=this;this.a.push=function(){var e=[].slice.call(arguments,0),t=r.apply(n.a,e);return a(n,e),t},t.processNow&&this.process()}function a(e,s,n){if(n=void 0!==n&&n,e.i&&(e.f.push.apply(e.f,s),!e.g))for(;0<e.f.length;){if("array"===t(s=e.f.shift()))e:{var a=e.c;t(s[0]);for(var l=s[0].split("."),h=l.pop(),c=s.slice(1),u=0;u<l.length;u++){if(void 0===a[l[u]])break e;a=a[l[u]]}try{a[h].apply(a,c)}catch(e){}}else if("arguments"===t(s)){if(l=e,h=[],c=s[0],l.b[c])for(a=l.b[c].length,u=0;u<a;u++)h.push(l.b[c][u].apply(l.h,[].slice.call(s,1)));e.f.push.apply(e.f,h)}else if("function"==typeof s)try{s.call(e.h)}catch(e){}else{if(!r(s))continue;for(var p in s)i(o(p,s[p]),e.c)}n||(e.g=!0,e.l(e.c,s),e.g=!1)}}n.prototype.process=function(){this.registerProcessor("set",(function(){var e={};return 1===arguments.length&&"object"===t(arguments[0])?e=arguments[0]:2===arguments.length&&"string"===t(arguments[0])&&(e=o(arguments[0],arguments[1])),e})),this.i=!0;for(var e=this.a.length,s=0;s<e;s++)a(this,[this.a[s]],!this.j)},n.prototype.get=function(e){var t=this.c;e=e.split(".");for(var s=0;s<e.length;s++){if(void 0===t[e[s]])return;t=t[e[s]]}return t},n.prototype.flatten=function(){this.a.splice(0,this.a.length),this.a[0]={},i(this.c,this.a[0])},n.prototype.registerProcessor=function(e,t){e in this.b||(this.b[e]=[]),this.b[e].push(t)},n.prototype.registerProcessor=n.prototype.registerProcessor,n.prototype.flatten=n.prototype.flatten,n.prototype.get=n.prototype.get,n.prototype.process=n.prototype.process,window.DataLayerHelper=n}();class e{static MODELS="dlval-models";static FORMS="dlval-forms";constructor(e=!1){e||(this.clearAllForms(),this.clearAllModels())}getForm(e){return this.getAllForms()[e]}storeForm(t,s){const r=this.getAllForms();r[t]=s,localStorage.setItem(e.FORMS,JSON.stringify(r))}getAllForms(){const t=localStorage.getItem(e.FORMS)||"{}";return JSON.parse(t)}clearAllForms(){localStorage.removeItem(e.FORMS)}storeModel(t,s){const r=this.getAllModels(),o=r[t]||[],i=JSON.stringify(s);for(let e=0;e<o.length;e++){if(i==JSON.stringify(o[e]))return}o.push(s),r[t]=o,localStorage.setItem(e.MODELS,JSON.stringify(r))}getAllModels(){const t=localStorage.getItem(e.MODELS)||"{}";return JSON.parse(t)}getModels(e){return this.getAllModels()[e]||[]}clearAllModels(){localStorage.removeItem(e.MODELS)}}class t{constructor(e){this.storage=e,this.checks=[]}addCheck(e){this.checks.push(e)}checkModel(e,t){const s=this.checks.find((t=>t.model==e));if(s){const e=this.#e(s.unique,t),r=this.storage.getModels(e),o=this.#t(t,r,s.params);return this.storage.storeModel(e,t),o}}#t(e,t,s){const r={};return t.forEach((t=>{s.forEach((s=>{t[s]!=e[s]&&(r[s]=r[s]||new Set,r[s].add(this.#s(t[s])),r[s].add(this.#s(e[s])))}))})),Object.keys(r).forEach((e=>{r[e]=Array.from(r[e].values())})),Object.keys(r).length?r:null}#e(e,t){return e.map((e=>t[e])).join("-")}#s(e){return"string"==typeof e?`"${e}"`:null===e?"null":void 0===e?"undefined":e}}class s{constructor(e,t){this.storage=t,this.settings=e}onEvent(e){const t=e[this.settings.params.id],s=this.#r(e.event),r={};if(s&&t){const o=this.storage.getForm(t)||{lastInputs:{}},i=this.settings.forms.find((e=>e.id==t)),n=e[this.settings.params.stepName],a=e[this.settings.params.fieldName],l=e[this.settings.params.fieldValue],h=this.#o(e[this.settings.params.inputElement]);switch(!!this.settings.forms.find((e=>e.id===t))||(r[this.settings.params.id]=`unknown form '${t}' - known forms are: ${this.settings.forms.map((e=>e.id)).join(", ")}`),s){case"start":o.inProgress&&(r.event="start event already detected for this form"),o.inProgress=!0;break;case"complete":case"abandon":o.inProgress||(r.event=`form not started: ${t}`),o.inProgress=!1;break;case"step":case"field":case"error":case"submit":o.inProgress||(r.event=`form not started: ${t}`)}switch(s){case"step":n&&(i.steps?.length&&!i.steps.includes(n)&&(r[this.settings.params.stepName]=`unknown step '${n}' - known steps are: ${i.steps.join(", ")}`),o.lastStepName==n&&(r[this.settings.params.stepName]="already on this step"),o.lastStepName=n);break;case"field":if(a&&h){h==o.lastInputs[a]&&(r.event="field value has not changed since last event"),o.lastInputs[a]=h}if(a&&l){const e=this.#i(a,l);console.log("grrr",e),e&&(r[this.settings.params.fieldValue]="potential PII detected - should this be undefined?")}}o.lastEventId=s,this.storage.storeForm(t,o)}return r}#i(e,t){return!!t&&(!!/.+\@.+\..+/i.test(t)||(e=e.toLowerCase(),-1!=["first name","last name","name","email","email address","phone","telephone","phone number","mobile","mobile number","dob","date of birth"].indexOf(e)))}#o(e){if(e&&e instanceof HTMLElement&&["INPUT","TEXTAREA","SELECT"].includes(e.tagName))return e.value}#r(e){const t=this.settings.events;for(let s in t)if(t[s]==e)return s}}class r{static TYPE_STRING="string";static TYPE_ARRAY="array";static TYPE_OBJECT="object";static TYPE_BOOLEAN="boolean";static TYPE_INTEGER="integer";static TYPE_DECIMAL2="decimal2";static TYPE_DECIMAL="decimal";static TYPE_INPUT_ELEMENT="input element";static TYPE_HTML_ELEMENT="html element";static TYPE_UNKNOWN="unknown";constructor(e){this.config=e,this.config.events.forEach((e=>{if(e.params=e.params||[],e.model){const t=this.getModelParamSchemas(e.model);e.params.forEach((e=>{for(let s=0;s<t.length;s++)t[s].key==e.key&&(t.splice(s,1),s--)})),e.params=[...t,...e.params]}})),this.modelConsistency=e.modelConsistency,this.client=e.client,this.project=e.project}findEventSchema(e){return this.config.events.find((t=>t.event==e))}getModelParamSchemas(e){return(this.config.models[e]||[]).slice(0)}getUnknownParamSchemasForObj(e,t){t=t||[];const s=[];return Object.keys(e).forEach((r=>{"event"===r||t.find((e=>e.key===r))||s.push({nonSchema:!0,key:r,type:this.getInferedType(e[r])})})),s}getInferedType(e){return e instanceof HTMLElement?["INPUT","TEXTAREA","SELECT"].includes(e.tagName)?r.TYPE_INPUT_ELEMENT:r.TYPE_HTML_ELEMENT:Array.isArray(e)?r.TYPE_ARRAY:"object"==typeof e?r.TYPE_OBJECT:"string"==typeof e?r.TYPE_STRING:"boolean"==typeof e?r.TYPE_BOOLEAN:"number"==typeof e?Math.round(e)===e?r.TYPE_INTEGER:Number(e.toFixed(2))===e?r.TYPE_DECIMAL2:r.TYPE_DECIMAL:r.TYPE_UNKNOWN}}class o{constructor(e,t="black"){this.console=e,this.bgCol=t,this.args=[],this.styles=[],this.bgCol="black",this.strike=!1}setStrike(e){return this.strike=!!e,this}pushStyled(e,t,s=!1,r="12px",o="black"){return this.args.push(`%c${e}`),this.styles.push(`font-size: ${r}; ${s?"font-style: italic;":""} ${t?"color: "+t+";":""} padding-left: 4px; background: ${o}; text-decoration: ${this.strike?"line-through":"none"};`),this}pushKey(e){return this.pushStyled(e,"aqua")}pushType(e){return this.pushStyled(e,"grey")}pushIssue(e){return this.pushStyled(e,"lightcoral")}pushValue(e){return this.pushStyled(e,"lightskyblue")}pushTick(){return this.pushStyled("✔️ ok","lime")}pushX(){return this.pushStyled("❌","red")}pushWarn(){return this.pushStyled("⚠️","yellow")}log(){this.console.log(...this.#n(arguments)),this.args=[],this.styles=[]}group(){this.console.group(...this.#n(arguments)),this.args=[],this.styles=[]}#n(e){const t=[this.args.join(""),...this.styles];return e&&t.push(...e),t}}class i{constructor(e,t){this.logger=new o(window.console),this.logger.pushStyled(`DATALAYER VALIDATOR - ${e} - ${t}`,"lightgreen").log()}logResult(e){this.logger.setStrike(!1).pushStyled("VALIDATING","yellow").group("dataLayer.push(",e.msg,")"),this.logger.pushStyled("event","yellow").pushType("string").pushStyled(e.event.value,"yellow"),e.event.ok?this.logger.pushTick():this.logger.pushX(),e.event.issue&&this.logger.pushIssue(e.event.issue),this.logger.log(),e.params.forEach((e=>this.#a(e))),console.groupEnd()}#a(e,t){if(e.type===r.TYPE_ARRAY||e.type===r.TYPE_OBJECT){const t=this.#l(e);this.logger.setStrike(e.schema.nonSchema).pushKey(e.schema.key).pushType(t),!0===e.ok&&this.logger.pushTick(),!1===e.ok&&this.logger.pushX(),e.issue&&this.logger.pushIssue(e.issue),this.logger.group();Object.keys(e.children).forEach((t=>this.#a(e.children[t],e.consistency))),console.groupEnd()}else{const s=[r.TYPE_INPUT_ELEMENT,r.TYPE_HTML_ELEMENT].includes(e.schema.type);this.logger.setStrike(e.schema.nonSchema).pushKey(e.schema.key).pushType(e.schema.type).pushValue(s?`<${e.value.tagName.toLowerCase()}>`:e.value),!0!==e.ok||e.schema.nonSchema||"(not set)"==e.value||this.logger.pushTick(),!1===e.ok&&this.logger.pushX(),e.issue&&this.logger.pushIssue(e.issue),this.logger.log(),t&&t[e.schema.key]&&this.logger.pushWarn().pushStyled(`inconsistent ${e.schema.key} detected across events: `,"palegoldenrod").log(t[e.schema.key].join(" | "))}}#l(e){const t=e.type===r.TYPE_ARRAY?e.value.length:Object.keys(e.value).length;return e.type===r.TYPE_ARRAY?`array[${t}] (${e.schema.nonSchema?"unknown":e.schema.itemType})`:`object[${t}]`}}class n{constructor(o,n){o.dataLayer=o.dataLayer||[],this.schema=new r(n),this.storage=new e,this.consistency=new t(this.storage),this.schema.modelConsistency.forEach((e=>this.consistency.addCheck(e))),this.schema.formSettings&&(this.formCheck=new s(this.schema.formSettings,this.storage)),this.display=new i(this.schema.client,this.schema.project),this.helper=new DataLayerHelper(o.dataLayer,{listenToPast:!0,listener:this.#h.bind(this)})}reset(){this.storage.clearAllModels()}#c(e,t){t=t||[];for(let s=0;s<t.length;s++){if(!new RegExp(t[s],"i").test(e))return s}return-1}#u(e){return!(e=e.toLowerCase()).length||"null"==e||"undefined"==e}#p(e,t){const s={schema:t,value:e[t.key],ok:!0,children:{}};t.required&&null==e[t.key]&&(s.ok=!1,s.issue="required param is missing");const o=e[t.key];if(null!=o){const e=this.schema.getInferedType(o);if(s.type=e,t.nonSchema||e===t.type){if(e===r.TYPE_STRING){if(this.#u(o))s.ok=!1,s.issue="please use raw undefined";else{const e=this.#c(o,t.validation);-1!=e&&(s.ok=!1,s.issue="should match regex: "+t.validation[e])}s.value='"'+s.value+'"'}else if(e===r.TYPE_ARRAY)o.length?(s.ok=null,o.forEach(((e,r)=>{s.children[r]=this.#p(o,{key:r,nonSchema:t.nonSchema,type:t.itemType,model:t.model,required:!0})}))):t.required&&(s.ok=!1,s.issue="at least one item is required");else if(e===r.TYPE_OBJECT){s.ok=null;const e=this.schema.getModelParamSchemas(t.model),r=this.schema.getUnknownParamSchemasForObj(o,e),i=[...e,...r];s.consistency=this.consistency.checkModel(t.model,o),i.forEach(((e,t)=>{s.children[e.key]=this.#p(o,e)}))}}else s.ok=!1,s.issue="should be of type "+t.type}else e.hasOwnProperty(t.key)||(s.value="(not set)");return s}#h(e,t){const s={msg:t,event:{ok:!0,value:t.event},params:[]};if(!t.event)return s.event.value="(not set)",s.event.ok=!1,s.event.issue="required event param is missing",void this.display.logResult(s);const r=this.schema.findEventSchema(t.event);if(r){const e=this.schema.getUnknownParamSchemasForObj(t,r.params);s.params=[...r.params,...e].map((e=>this.#p(t,e)))}else{s.event.ok=!1,s.event.issue="unknown schema event";const e=this.schema.getUnknownParamSchemasForObj(t);s.params=e.map((e=>this.#p(t,e)))}if(this.formCheck){const e=this.formCheck.onEvent(t);e.event&&(s.event.ok=!1,s.event.issue=e.event),s.params.forEach((t=>{!1!==t.ok&&e[t.schema.key]&&(t.ok=!1,t.issue=e[t.schema.key])}))}this.display.logResult(s)}}window.initDataLayerValidator=e=>{fetch(e).then((e=>e.json())).then((e=>{new n(window,e)}))}})();
