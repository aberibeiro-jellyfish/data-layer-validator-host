(()=>{!function(){"use strict";var e=/\[object (Boolean|Number|String|Function|Array|Date|RegExp|Arguments)\]/;function t(t){return null==t?String(t):(t=e.exec(Object.prototype.toString.call(Object(t))))?t[1].toLowerCase():"object"}function s(e,t){return Object.prototype.hasOwnProperty.call(Object(e),t)}function n(e){if(!e||"object"!=t(e)||e.nodeType||e==e.window)return!1;try{if(e.constructor&&!s(e,"constructor")&&!s(e.constructor.prototype,"isPrototypeOf"))return!1}catch(e){return!1}for(var n in e);return void 0===n||s(e,n)}function o(e,t){var s={},n=s;e=e.split(".");for(var o=0;o<e.length-1;o++)n=n[e[o]]={};return n[e[e.length-1]]=t,s}function r(e,o){var i,a=!e._clear;for(i in e)if(s(e,i)){var l=e[i];"array"===t(l)&&a?("array"===t(o[i])||(o[i]=[]),r(l,o[i])):n(l)&&a?(n(o[i])||(o[i]={}),r(l,o[i])):o[i]=l}delete o._clear}function i(e,t,s){t="function"==typeof(t=void 0===t?{}:t)?{listener:t,listenToPast:void 0!==s&&s,processNow:!0,commandProcessors:{}}:{listener:t.listener||function(){},listenToPast:t.listenToPast||!1,processNow:void 0===t.processNow||t.processNow,commandProcessors:t.commandProcessors||{}},this.a=e,this.l=t.listener,this.j=t.listenToPast,this.g=this.i=!1,this.c={},this.f=[],this.b=t.commandProcessors,this.h=function(e){return{set:function(t,s){r(o(t,s),e.c)},get:function(t){return e.get(t)}}}(this);var n=this.a.push,i=this;this.a.push=function(){var e=[].slice.call(arguments,0),t=n.apply(i.a,e);return a(i,e),t},t.processNow&&this.process()}function a(e,s,i){if(i=void 0!==i&&i,e.i&&(e.f.push.apply(e.f,s),!e.g))for(;0<e.f.length;){if("array"===t(s=e.f.shift()))e:{var a=e.c;t(s[0]);for(var l=s[0].split("."),c=l.pop(),h=s.slice(1),u=0;u<l.length;u++){if(void 0===a[l[u]])break e;a=a[l[u]]}try{a[c].apply(a,h)}catch(e){}}else if("arguments"===t(s)){if(l=e,c=[],h=s[0],l.b[h])for(a=l.b[h].length,u=0;u<a;u++)c.push(l.b[h][u].apply(l.h,[].slice.call(s,1)));e.f.push.apply(e.f,c)}else if("function"==typeof s)try{s.call(e.h)}catch(e){}else{if(!n(s))continue;for(var p in s)r(o(p,s[p]),e.c)}i||(e.g=!0,e.l(e.c,s),e.g=!1)}}i.prototype.process=function(){this.registerProcessor("set",(function(){var e={};return 1===arguments.length&&"object"===t(arguments[0])?e=arguments[0]:2===arguments.length&&"string"===t(arguments[0])&&(e=o(arguments[0],arguments[1])),e})),this.i=!0;for(var e=this.a.length,s=0;s<e;s++)a(this,[this.a[s]],!this.j)},i.prototype.get=function(e){var t=this.c;e=e.split(".");for(var s=0;s<e.length;s++){if(void 0===t[e[s]])return;t=t[e[s]]}return t},i.prototype.flatten=function(){this.a.splice(0,this.a.length),this.a[0]={},r(this.c,this.a[0])},i.prototype.registerProcessor=function(e,t){e in this.b||(this.b[e]=[]),this.b[e].push(t)},i.prototype.registerProcessor=i.prototype.registerProcessor,i.prototype.flatten=i.prototype.flatten,i.prototype.get=i.prototype.get,i.prototype.process=i.prototype.process,window.DataLayerHelper=i}();class e{static MODELS="dlval-models";static FORMS="dlval-forms";constructor(e=!1){e||(this.clearAllForms(),this.clearAllModels())}getForm(e){return this.getAllForms()[e]}storeForm(t,s){const n=this.getAllForms();n[t]=s,localStorage.setItem(e.FORMS,JSON.stringify(n))}getAllForms(){const t=localStorage.getItem(e.FORMS)||"{}";return JSON.parse(t)}clearAllForms(){localStorage.removeItem(e.FORMS)}storeModel(t,s){const n=this.getAllModels(),o=n[t]||[],r=JSON.stringify(s);for(let e=0;e<o.length;e++){if(r==JSON.stringify(o[e]))return}o.push(s),n[t]=o,localStorage.setItem(e.MODELS,JSON.stringify(n))}getAllModels(){const t=localStorage.getItem(e.MODELS)||"{}";return JSON.parse(t)}getModels(e){return this.getAllModels()[e]||[]}clearAllModels(){localStorage.removeItem(e.MODELS)}}class t{constructor(e){this.storage=e,this.checks=[]}addCheck(e){this.checks.push(e)}checkModel(e,t){const s=this.checks.find((t=>t.model==e));if(s){const e=this.#e(s.unique,t),n=this.storage.getModels(e),o=this.#t(t,n,s.params);return this.storage.storeModel(e,t),o}}#t(e,t,s){const n={};return t.forEach((t=>{s.forEach((s=>{t[s]!=e[s]&&(n[s]=n[s]||new Set,n[s].add(this.#s(t[s])),n[s].add(this.#s(e[s])))}))})),Object.keys(n).forEach((e=>{n[e]=Array.from(n[e].values())})),Object.keys(n).length?n:null}#e(e,t){return e.map((e=>t[e])).join("-")}#s(e){return"string"==typeof e?`"${e}"`:null===e?"null":void 0===e?"undefined":e}}class s{constructor(e,t){this.storage=t,this.settings=e}onEvent(e){const t=e[this.settings.params.id],s=this.#n(e.event),n={};if(s&&t){const o=this.storage.getForm(t)||{lastInputs:{}},r=this.settings.forms.find((e=>e.id==t)),i=e[this.settings.params.stepName],a=e[this.settings.params.fieldName],l=e[this.settings.params.fieldValue],c=this.#o(e[this.settings.params.inputElement]);switch(!!this.settings.forms.find((e=>e.id===t))||(n[this.settings.params.id]=`unknown form '${t}' - known forms are: ${this.settings.forms.map((e=>e.id)).join(", ")}`),s){case"start":o.inProgress&&(n.event="start event already detected for this form"),o.inProgress=!0;break;case"complete":case"abandon":o.inProgress||(n.event=`form not started: ${t}`),o.inProgress=!1;break;case"step":case"field":case"error":case"submit":o.inProgress||(n.event=`form not started: ${t}`)}switch(s){case"step":i&&(r.steps?.length&&!r.steps.includes(i)&&(n[this.settings.params.stepName]=`unknown step '${i}' - known steps are: ${r.steps.join(", ")}`),o.lastStepName==i&&(n[this.settings.params.stepName]="already on this step"),o.lastStepName=i);break;case"field":if(a&&c){c==o.lastInputs[a]&&(n.event="field value has not changed since last event"),o.lastInputs[a]=c}if(a&&l){const e=this.#r(a,l);console.log("grrr",e),e&&(n[this.settings.params.fieldValue]="potential PII detected - should this be undefined?")}}o.lastEventId=s,this.storage.storeForm(t,o)}return n}#r(e,t){return!!t&&(!!/.+\@.+\..+/i.test(t)||(e=e.toLowerCase(),-1!=["first name","last name","name","email","email address","phone","telephone","phone number","mobile","mobile number","dob","date of birth"].indexOf(e)))}#o(e){if(e&&e instanceof HTMLElement&&["INPUT","TEXTAREA","SELECT"].includes(e.tagName))return e.value}#n(e){const t=this.settings.events;for(let s in t)if(t[s]==e)return s}}class n{static TYPE_STRING="string";static TYPE_ARRAY="array";static TYPE_OBJECT="object";static TYPE_BOOLEAN="boolean";static TYPE_INTEGER="integer";static TYPE_DECIMAL2="decimal2";static TYPE_DECIMAL="decimal";static TYPE_INPUT_ELEMENT="input element";static TYPE_HTML_ELEMENT="html element";static TYPE_UNDEFINED="undefined";static TYPE_UNKNOWN="unknown";constructor(e){this.config=e,this.config.events.forEach((e=>{if(e.params=e.params||[],e.model){const t=this.getModelParamSchemas(e.model);e.params.forEach((e=>{for(let s=0;s<t.length;s++)t[s].key==e.key&&(t.splice(s,1),s--)})),e.params=[...t,...e.params]}}))}getModelConsistency(){return this.config.modelConsistency||[]}findEventNameFromAliases(e){if(!this.config.eventAliases)return null;for(let t=0;t<this.config.eventAliases.length;t++){const s=this.config.eventAliases[t];if(e.event==[s.event])return{value:e[s.alias],alias:s.alias}}}isInitialData(e){if(!this.config.initialData)return!1;if(e.event&&!this.config.initialData.events.includes(e.event))return!1;let t=0;const s=this.config.initialData.identifiedBy;for(let n=0;n<s.length;n++)null!=e[s[n]]&&t++;return t===s.length}isIgnoredEvent(e){if(!e||!this.config.ignoredEvents)return!1;for(let t=0;t<this.config.ignoredEvents.length;t++){const s=this.config.ignoredEvents[t];if(new RegExp(s,"i").test(e))return!0}return!1}isValidEventNameFormat(e){if(!e||!this.config.globalEventNameValidation)return!0;for(let t=0;t<this.config.globalEventNameValidation.length;t++){const s=this.config.globalEventNameValidation[t];if(!new RegExp(s).test(e))return!1}return!0}findEventSchema(e){return this.config.events.find((t=>{if(!t.identify)return!1;for(let s=0;s<t.identify.length;s++){const n=t.identify[s];if(!e.hasOwnProperty(n.key))return!1;const o=String(e[n.key])||"";if(!new RegExp(n.matcher).test(o))return!1}return!0}))}getModelParamSchemas(e){return(this.config.models[e]||[]).slice(0)}getIgnoredParams(){return this.config.ignoredParams||[]}getUnknownParamSchemasForObj(e,t){t=t||[];const s=[];return Object.keys(e).forEach((n=>{this.getIgnoredParams().includes(n)||t.find((e=>e.key===n))||s.push({nonSchema:!0,key:n,type:this.getInferedType(e[n])})})),s}getInferedType(e){return e instanceof HTMLElement?["INPUT","TEXTAREA","SELECT"].includes(e.tagName)?n.TYPE_INPUT_ELEMENT:n.TYPE_HTML_ELEMENT:Array.isArray(e)?n.TYPE_ARRAY:"object"==typeof e?n.TYPE_OBJECT:"string"==typeof e?n.TYPE_STRING:"boolean"==typeof e?n.TYPE_BOOLEAN:"number"==typeof e?Math.round(e)===e?n.TYPE_INTEGER:Number(e.toFixed(2))===e?n.TYPE_DECIMAL2:n.TYPE_DECIMAL:null==e?n.TYPE_UNDEFINED:n.TYPE_UNKNOWN}typesMatch(e,t){let s=this.getInferedType(e);if(s===t)return!0;if([n.TYPE_INTEGER,n.TYPE_DECIMAL,n.TYPE_DECIMAL2].includes(t)&&s===n.TYPE_STRING){const t=Number(e);isNaN(t)||(s=this.getInferedType(t))}return!(t!=n.TYPE_BOOLEAN||!["true","false"].includes(e))||(s===n.TYPE_INTEGER&&(t===n.TYPE_DECIMAL2||t===n.TYPE_DECIMAL)||s===n.TYPE_DECIMAL2&&t===n.TYPE_DECIMAL)}}class o{constructor(e,t="black"){this.console=e,this.bgCol=t,this.args=[],this.styles=[],this.bgCol="black",this.strike=!1}setStrike(e){return this.strike=!!e,this}pushStyled(e,t,s=!1,n="12px",o="black"){return this.args.push(`%c${e}`),this.styles.push(`font-size: ${n}; ${s?"font-style: italic;":""} ${t?"color: "+t+";":""} padding-left: 4px; background: ${o}; text-decoration: ${this.strike?"line-through":"none"};`),this}pushKey(e){return this.pushStyled(e,"aqua")}pushType(e){return this.pushStyled(e,"grey")}pushIssue(e){return this.pushStyled(e,"lightcoral")}pushValue(e){return this.pushStyled(e,"lightskyblue")}pushTick(){return this.pushStyled("✔️ ok","lime")}pushX(){return this.pushStyled("❌","red")}pushWarn(){return this.pushStyled("⚠️","yellow")}log(){this.console.log(...this.#i(arguments)),this.args=[],this.styles=[]}group(){this.console.group(...this.#i(arguments)),this.args=[],this.styles=[]}groupCollapsed(){this.console.groupCollapsed(...this.#i(arguments)),this.args=[],this.styles=[]}#i(e){const t=[this.args.join(""),...this.styles];return e&&t.push(...e),t}}class r{constructor(){this.logger=new o(window.console)}logWelcome(e,t){this.logger.pushStyled("DL VALIDATOR: INFO (click to expand)","lightgreen").groupCollapsed(),this.logger.pushStyled(`Client: ${e.client}\nSchema name: ${e.name}\nSchema version: ${e.version}\nSchema template version: ${e.templateVersion}\nTool compatability: ${e.libVersion}`,"lightgreen").log(),this.logger.pushStyled("Please set your dev tools to use the Dark theme for better display","yellow").log(),e.downloadableReport&&(this.logger.pushStyled(`Number of stored results: ${t}`,"red").log(),this.logger.pushStyled("To download stored results, press CTRL+SHIFT+L (windows) or COMMAND+SHIFT+L (mac)\nTo clear stored results, press CTRL+SHIFT+K (windows) or COMMAND+SHIFT+K (mac)","salmon").log(),this.logger.pushStyled("IMPORTANT: Make sure to click somewhere on the webpage before pressing the key combo","red").log()),console.groupEnd()}logResult(e){this.logger.setStrike(!1).pushStyled("DL VALIDATOR: ","yellow").pushStyled(`${e.name||"(unknown event)"}`,"black",!1,"12px","yellow").group(),this.logger.pushStyled("page:","white").pushStyled(e.page,"lightgrey",!0).log(),e.params.forEach((e=>this.#a(e))),console.groupEnd()}#a(e,t){if(e.type===n.TYPE_ARRAY||e.type===n.TYPE_OBJECT){const t=this.#l(e);this.logger.pushKey(e.schema.key).pushType(t),e.schema.nonSchema?this.logger.pushWarn().pushStyled("unknown","yellow"):(!0===e.ok&&this.logger.pushTick(),!1===e.ok&&this.logger.pushX(),e.issue&&this.logger.pushIssue(e.issue)),this.logger.group();Object.keys(e.children).forEach((t=>this.#a(e.children[t],e.consistency))),console.groupEnd()}else{let s=e.value;[n.TYPE_INPUT_ELEMENT,n.TYPE_HTML_ELEMENT].includes(e.schema.type)?s=`<${e.value.tagName.toLowerCase()}>`:"string"===e.schema.type&&"(not set)"!=s&&(s='"'+s+'"'),this.logger.pushKey(e.schema.key).pushType(e.schema.type).pushValue(s),e.schema.nonSchema?this.logger.pushWarn().pushStyled("unknown","yellow"):(!0===e.ok&&"(not set)"!=e.value&&this.logger.pushTick(),!1===e.ok&&this.logger.pushX(),e.issue&&this.logger.pushIssue(e.issue)),this.logger.log(),t&&t[e.schema.key]&&this.logger.pushWarn().pushStyled(`inconsistent ${e.schema.key} detected across events: `,"palegoldenrod").log(t[e.schema.key].join(" | "))}}#l(e){const t=e.type===n.TYPE_ARRAY?e.value.length:Object.keys(e.value).length;return e.type===n.TYPE_ARRAY?`array[${t}] (${e.schema.nonSchema?"unknown":e.schema.itemType})`:`object[${t}]`}}
/**! 
 * hotkeys-js v3.10.2 
 * A simple micro-library for defining and dispatching keyboard shortcuts. It has no dependencies. 
 * 
 * Copyright (c) 2023 kenny wong <wowohoo@qq.com> 
 * http://jaywcjlove.github.io/hotkeys 
 * Licensed under the MIT license 
 */
var i="undefined"!=typeof navigator&&navigator.userAgent.toLowerCase().indexOf("firefox")>0;function a(e,t,s,n){e.addEventListener?e.addEventListener(t,s,n):e.attachEvent&&e.attachEvent("on".concat(t),(function(){s(window.event)}))}function l(e,t){for(var s=t.slice(0,t.length-1),n=0;n<s.length;n++)s[n]=e[s[n].toLowerCase()];return s}function c(e){"string"!=typeof e&&(e="");for(var t=(e=e.replace(/\s/g,"")).split(","),s=t.lastIndexOf("");s>=0;)t[s-1]+=",",t.splice(s,1),s=t.lastIndexOf("");return t}for(var h={backspace:8,"⌫":8,tab:9,clear:12,enter:13,"↩":13,return:13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,delete:46,ins:45,insert:45,home:36,end:35,pageup:33,pagedown:34,capslock:20,num_0:96,num_1:97,num_2:98,num_3:99,num_4:100,num_5:101,num_6:102,num_7:103,num_8:104,num_9:105,num_multiply:106,num_add:107,num_enter:108,num_subtract:109,num_decimal:110,num_divide:111,"⇪":20,",":188,".":190,"/":191,"`":192,"-":i?173:189,"=":i?61:187,";":i?59:186,"'":222,"[":219,"]":221,"\\":220},u={"⇧":16,shift:16,"⌥":18,alt:18,option:18,"⌃":17,ctrl:17,control:17,"⌘":91,cmd:91,command:91},p={16:"shiftKey",18:"altKey",17:"ctrlKey",91:"metaKey",shiftKey:16,ctrlKey:17,altKey:18,metaKey:91},d={16:!1,18:!1,17:!1,91:!1},g={},f=1;f<20;f++)h["f".concat(f)]=111+f;var m=[],y=!1,E="all",v=[],k=function(e){return h[e.toLowerCase()]||u[e.toLowerCase()]||e.toUpperCase().charCodeAt(0)};function w(e){E=e||"all"}function T(){return E||"all"}var S=function(e){var t=e.key,s=e.scope,n=e.method,o=e.splitKey,r=void 0===o?"+":o;c(t).forEach((function(e){var t=e.split(r),o=t.length,i=t[o-1],a="*"===i?"*":k(i);if(g[a]){s||(s=T());var c=o>1?l(u,t):[];g[a]=g[a].filter((function(e){return!((!n||e.method===n)&&e.scope===s&&function(e,t){for(var s=e.length>=t.length?e:t,n=e.length>=t.length?t:e,o=!0,r=0;r<s.length;r++)-1===n.indexOf(s[r])&&(o=!1);return o}(e.mods,c))}))}}))};function b(e,t,s,n){var o;if(t.element===n&&(t.scope===s||"all"===t.scope)){for(var r in o=t.mods.length>0,d)Object.prototype.hasOwnProperty.call(d,r)&&(!d[r]&&t.mods.indexOf(+r)>-1||d[r]&&-1===t.mods.indexOf(+r))&&(o=!1);(0!==t.mods.length||d[16]||d[18]||d[17]||d[91])&&!o&&"*"!==t.shortcut||!1===t.method(e,t)&&(e.preventDefault?e.preventDefault():e.returnValue=!1,e.stopPropagation&&e.stopPropagation(),e.cancelBubble&&(e.cancelBubble=!0))}}function O(e,t){var s=g["*"],n=e.keyCode||e.which||e.charCode;if(P.filter.call(this,e)){if(93!==n&&224!==n||(n=91),-1===m.indexOf(n)&&229!==n&&m.push(n),["ctrlKey","altKey","shiftKey","metaKey"].forEach((function(t){var s=p[t];e[t]&&-1===m.indexOf(s)?m.push(s):!e[t]&&m.indexOf(s)>-1?m.splice(m.indexOf(s),1):"metaKey"===t&&e[t]&&3===m.length&&(e.ctrlKey||e.shiftKey||e.altKey||(m=m.slice(m.indexOf(s))))})),n in d){for(var o in d[n]=!0,u)u[o]===n&&(P[o]=!0);if(!s)return}for(var r in d)Object.prototype.hasOwnProperty.call(d,r)&&(d[r]=e[p[r]]);e.getModifierState&&(!e.altKey||e.ctrlKey)&&e.getModifierState("AltGraph")&&(-1===m.indexOf(17)&&m.push(17),-1===m.indexOf(18)&&m.push(18),d[17]=!0,d[18]=!0);var i=T();if(s)for(var a=0;a<s.length;a++)s[a].scope===i&&("keydown"===e.type&&s[a].keydown||"keyup"===e.type&&s[a].keyup)&&b(e,s[a],i,t);if(n in g)for(var l=0;l<g[n].length;l++)if(("keydown"===e.type&&g[n][l].keydown||"keyup"===e.type&&g[n][l].keyup)&&g[n][l].key){for(var c=g[n][l],h=c.splitKey,f=c.key.split(h),y=[],E=0;E<f.length;E++)y.push(k(f[E]));y.sort().join("")===m.sort().join("")&&b(e,c,i,t)}}}function P(e,t,s){m=[];var n=c(e),o=[],r="all",i=document,h=0,p=!1,f=!0,E="+",w=!1;for(void 0===s&&"function"==typeof t&&(s=t),"[object Object]"===Object.prototype.toString.call(t)&&(t.scope&&(r=t.scope),t.element&&(i=t.element),t.keyup&&(p=t.keyup),void 0!==t.keydown&&(f=t.keydown),void 0!==t.capture&&(w=t.capture),"string"==typeof t.splitKey&&(E=t.splitKey)),"string"==typeof t&&(r=t);h<n.length;h++)o=[],(e=n[h].split(E)).length>1&&(o=l(u,e)),(e="*"===(e=e[e.length-1])?"*":k(e))in g||(g[e]=[]),g[e].push({keyup:p,keydown:f,scope:r,mods:o,shortcut:n[h],method:s,key:n[h],splitKey:E,element:i});void 0!==i&&!function(e){return v.indexOf(e)>-1}(i)&&window&&(v.push(i),a(i,"keydown",(function(e){O(e,i)}),w),y||(y=!0,a(window,"focus",(function(){m=[]}),w)),a(i,"keyup",(function(e){O(e,i),function(e){var t=e.keyCode||e.which||e.charCode,s=m.indexOf(t);if(s>=0&&m.splice(s,1),e.key&&"meta"===e.key.toLowerCase()&&m.splice(0,m.length),93!==t&&224!==t||(t=91),t in d)for(var n in d[t]=!1,u)u[n]===t&&(P[n]=!1)}(e)}),w))}var A={getPressedKeyString:function(){return m.map((function(e){return t=e,Object.keys(h).find((function(e){return h[e]===t}))||function(e){return Object.keys(u).find((function(t){return u[t]===e}))}(e)||String.fromCharCode(e);var t}))},setScope:w,getScope:T,deleteScope:function(e,t){var s,n;for(var o in e||(e=T()),g)if(Object.prototype.hasOwnProperty.call(g,o))for(s=g[o],n=0;n<s.length;)s[n].scope===e?s.splice(n,1):n++;T()===e&&w(t||"all")},getPressedKeyCodes:function(){return m.slice(0)},isPressed:function(e){return"string"==typeof e&&(e=k(e)),-1!==m.indexOf(e)},filter:function(e){var t=e.target||e.srcElement,s=t.tagName,n=!0;return!t.isContentEditable&&("INPUT"!==s&&"TEXTAREA"!==s&&"SELECT"!==s||t.readOnly)||(n=!1),n},trigger:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"all";Object.keys(g).forEach((function(s){g[s].filter((function(s){return s.scope===t&&s.shortcut===e})).forEach((function(e){e&&e.method&&e.method()}))}))},unbind:function(e){if(void 0===e)Object.keys(g).forEach((function(e){return delete g[e]}));else if(Array.isArray(e))e.forEach((function(e){e.key&&S(e)}));else if("object"==typeof e)e.key&&S(e);else if("string"==typeof e){for(var t=arguments.length,s=new Array(t>1?t-1:0),n=1;n<t;n++)s[n-1]=arguments[n];var o=s[0],r=s[1];"function"==typeof o&&(r=o,o=""),S({key:e,scope:o,method:r,splitKey:"+"})}},keyMap:h,modifier:u,modifierMap:p};for(var I in A)Object.prototype.hasOwnProperty.call(A,I)&&(P[I]=A[I]);if("undefined"!=typeof window){var N=window.hotkeys;P.noConflict=function(e){return e&&window.hotkeys===P&&(window.hotkeys=N),P},window.hotkeys=P}class C{static STORAGE_KEY="downloader-logs";constructor(e){this.client=e.client,this.name=e.name,this.schemaVersion=e.version,this.libVersion=e.libVersion,this.logs=localStorage.getItem(C.STORAGE_KEY)||"[]",this.logs=JSON.parse(this.logs),P("ctrl+shift+l,command+shift+l",((e,t)=>{this.#c()})),P("ctrl+shift+k,command+shift+k",((e,t)=>{this.#h()}))}logResult(e){this.logs.push(e),localStorage.setItem(C.STORAGE_KEY,JSON.stringify(this.logs))}getStoredResultsCount(){let e=localStorage.getItem(C.STORAGE_KEY)||"[]";return e=JSON.parse(e),e.length}#h(){this.logs=[],localStorage.removeItem(C.STORAGE_KEY),alert("All DL validation results cleared from storage")}#c(){const e="index,page,internal name,property,value,expected type,expected case,validation,example,description,,status,note".split(","),t=[];for(let e=0;e<this.logs.length;e++){const t=this.logs[e],n=e+1,o=t.name||"(unknown)",r=t.page;t.params.forEach((e=>s(e,n,o,r)))}function s(n,o,r,i,a=""){const l=new Array(e.length).fill("");l[e.indexOf("index")]=o,l[e.indexOf("internal name")]=r,l[e.indexOf("page")]=i,l[e.indexOf("expected case")]=n.schema.lowercase?"lowercase":n.schema.uppercase?"uppercase":"any",l[e.indexOf("validation")]=n.schema.validation?n.schema.validation.join(" // "):"",l[e.indexOf("example")]=n.schema.example||"",l[e.indexOf("description")]=n.schema.description||"";const c=a?a+"."+n.schema.key:n.schema.key;if(l[e.indexOf("property")]=c,n.schema.nonSchema||(l[e.indexOf("expected type")]=n.schema.type),"object"!=typeof n.value&&(l[e.indexOf("value")]=n.value),n.schema.nonSchema||(l[e.indexOf("status")]=!0===n.ok?"OK":!1===n.ok?"KO":""),n.schema.nonSchema||(l[e.indexOf("note")]=n.issue||""),t.push(l),["array","object"].includes(n.schema.type)&&!n.schema.nonSchema){Object.keys(n.children).forEach((e=>s(n.children[e],o,r,i,c)))}}const n=e.join("\t")+"\n"+t.map((e=>e.join("\t"))).join("\n");var o,r,i;o=`${window.location.hostname}-${this.client}-${this.name}-v${this.schemaVersion}-${(new Date).toDateString()}.csv`,r=n,(i=document.createElement("a")).setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(r)),i.setAttribute("download",o),i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i)}}const _="0.2.4";class L{constructor(o,i){o.dataLayer=o.dataLayer||[],this.schema=new n(i),this.storage=new e,this.consistency=new t(this.storage),this.schema.getModelConsistency().forEach((e=>this.consistency.addCheck(e))),this.schema.formSettings&&(this.formCheck=new s(this.schema.formSettings,this.storage)),this.display=new r,_!=i.libVersion&&console.error(`This schema version may not compatible with the current validator library ${_}.`),i.downloadableReport&&(this.downloader=new C(i)),this.display.logWelcome(i,this.downloader?this.downloader.getStoredResultsCount():null),this.helper=new DataLayerHelper(o.dataLayer,{listenToPast:!0,listener:this.#u.bind(this)})}reset(){this.storage.clearAllModels()}#p(e,t){t=t||[];for(let s=0;s<t.length;s++){if(!new RegExp(t[s],"i").test(e))return s}return-1}#d(e){return!(e=e.toLowerCase()).length||"null"==e||"undefined"==e}#g(e,t){const s={schema:t,value:e[t.key],ok:!0,children:{}};t.required&&!e.hasOwnProperty(t.key)&&(s.ok=!1,s.issue="required param is missing");const o=e[t.key];if(null!=o){const e=this.schema.getInferedType(o);if(s.type=e,t.nonSchema||this.schema.typesMatch(o,t.type))if(e===n.TYPE_STRING)if(o&&!this.#f(o))s.ok=!1,s.issue="only latin characters allowed in value";else{const e=this.#p(o,t.validation);-1!=e?(s.ok=!1,s.issue="should match regex: "+t.validation[e]):t.uppercase&&!this.#m(o)?(s.ok=!1,s.issue="value must be all upper case"):t.lowercase&&!this.#y(o)?(s.ok=!1,s.issue="value must be all lower case"):this.#d(o)&&(s.ok=!1,s.issue="if meant to be blank, please use raw undefined")}else if(e===n.TYPE_ARRAY)o.length?(s.ok=null,o.forEach(((e,n)=>{s.children[n]=this.#g(o,{key:n,nonSchema:t.nonSchema,type:t.itemType,model:t.model,required:!0})}))):t.required&&(s.ok=!1,s.issue="at least one item is required");else if(e===n.TYPE_OBJECT){s.ok=null;let e=[];if(t.model){const n=this.schema.getModelParamSchemas(t.model),r=this.schema.getUnknownParamSchemasForObj(o,n);e=[...n,...r],s.consistency=this.consistency.checkModel(t.model,o)}if(t.properties){const s=this.schema.getUnknownParamSchemasForObj(o,t.properties);e=[...t.properties,...s]}e.forEach(((e,t)=>{s.children[e.key]=this.#g(o,e)}))}else n.TYPE_UNDEFINED;else s.ok=!1,s.issue="should be of type "+t.type}else e.hasOwnProperty(t.key)||(s.value="(not set)");return s}#f(e){return/^[\w\s\p{P}\u00C0-\u02AF]+$/u.test(e)}#m(e){return e===e.toUpperCase()}#y(e){return e===e.toLowerCase()}#u(e,t){if("object"!=typeof t||Array.from(t).length)return;if(this.schema.isIgnoredEvent(t.event))return;const s={msg:t,params:[]},n=this.schema.findEventSchema(t);if(n){s.name=n.name;const e=this.schema.getUnknownParamSchemasForObj(t,n.params);s.params=[...n.params,...e].map((e=>this.#g(t,e)))}else{const e=this.schema.getUnknownParamSchemasForObj(t);s.params=e.map((e=>this.#g(t,e)))}if(this.formCheck){const e=this.formCheck.onEvent(t);e.event,s.params.forEach((t=>{!1!==t.ok&&e[t.schema.key]&&(t.ok=!1,t.issue=e[t.schema.key])}))}s.page=window.location.pathname,this.downloader&&this.downloader.logResult(s),this.display.logResult(s)}}window.initDataLayerValidator=e=>{"string"!=typeof e?"object"!=typeof e||new L(window,e):fetch(e).then((e=>e.json())).then((e=>{new L(window,e)}))}})();
